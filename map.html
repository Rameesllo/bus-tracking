<!DOCTYPE html>
<html>
<head>
  <title>College Bus Live Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 100vh; width: 100%; }
  </style>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</head>

<body>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6H9bhWUuBU8J33HtvQCd1lmmdvMFgnuo",
  authDomain: "bus-tracking2.firebaseapp.com",
  databaseURL: "https://bus-tracking2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bus-tracking2",
  storageBucket: "bus-tracking2.appspot.com",
  messagingSenderId: "113097926596",
  appId: "1:113097926596:web:a5ee33ef8bb5cc34222691"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map = L.map("map").setView([11.134140689954181, 75.94287835862663], 14);

// Add Map Tiles
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20
}).addTo(map);

// College Location
const collegeLat = 11.134140689954181;
const collegeLng = 75.94287835862663;

L.marker([collegeLat, collegeLng]).addTo(map).bindPopup("College Destination");

// Route variable
let routeControl;

// Listen to bus location
const busRef = ref(db, "buses/bus1");

onValue(busRef, (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  const busLat = data.lat;
  const busLng = data.lng;

  // Add or update bus marker
  if (!window.busMarker) {
    window.busMarker = L.marker([busLat, busLng]).addTo(map);
  } else {
    window.busMarker.setLatLng([busLat, busLng]);
  }

  // Remove old route
  if (routeControl) {
    map.removeControl(routeControl);
  }

  // Draw new route
  routeControl = L.Routing.control({
    waypoints: [
      L.latLng(busLat, busLng),
      L.latLng(collegeLat, collegeLng)
    ],
    routeWhileDragging: false,
    addWaypoints: false,
    draggableWaypoints: false,
    show: false
  }).addTo(map);

});
</script>

</body>
</html>
